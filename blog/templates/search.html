<!DOCTYPE html>
<html lang="ko">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆê²€ìƒ‰</title>
    <link rel="stylesheet" href="{% static 'css/search.css' %}">
    <link rel="stylesheet" href="{% static 'css/header.css' %}">

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            // íƒ­ ë™ì‘ ì„¤ì •
            const tabs = document.querySelectorAll(".tab");
            const tabContents = document.querySelectorAll(".tab-content");

            tabs.forEach((tab, index) => {
                tab.addEventListener("click", () => {
                    tabs.forEach(t => t.classList.remove("active"));
                    tabContents.forEach(tc => tc.classList.remove("active"));

                    tab.classList.add("active");
                    tabContents[index].classList.add("active");
                });
            });

            // ìì„¸íˆë³´ê¸° í† ê¸€ ì„¤ì •
            document.querySelectorAll(".card-button").forEach((button) => {
                button.addEventListener("click", function () {
                    const detailsBox = this.nextElementSibling;
                    detailsBox.style.display = detailsBox.style.display === "block" ? "none" : "block";
                });
            });

            // ë‹«ê¸° ë²„íŠ¼ ë™ì‘ ì„¤ì •
            document.querySelectorAll(".close-button").forEach((closeButton) => {
                closeButton.addEventListener("click", function () {
                    const detailsBox = this.parentElement;
                    detailsBox.style.display = "none";
                });
            });

            // ì„œë²„ í†µì‹  í•¨ìˆ˜
            function addToFavorites(productId) {
                console.log("Added to favorites:", productId);
            }

            function removeFromFavorites(productId) {
                console.log("Removed from favorites:", productId);
            }
        });


        // ì˜ˆì ê¸ˆ ìì„¸íˆ ë³´ê¸° ë¡œê·¸ ìˆ˜ì§‘ì„ ìœ„í•œ ìë°” ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ ì¶”ê°€
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".card-button").forEach(button => {
                button.addEventListener("click", function () {
                    const card = this.closest(".card");
                    const productData = {
                        product_name: card.querySelector(".card-title").innerText.trim(),
                        bank: card.querySelector(".card-content p:nth-of-type(1)").innerText.replace("ì€í–‰:", "").trim(),
                        baser: card.querySelector(".card-content p:nth-of-type(2)").innerText.replace("ê¸°ì¤€ ê¸ˆë¦¬:", "").trim(),
                        maxir: card.querySelector(".card-content p:nth-of-type(3)").innerText.replace("ìµœëŒ€ ê¸ˆë¦¬:", "").trim(),
                        method: card.querySelector(".card-content p:nth-of-type(4)").innerText.replace("ê°€ì… ë°©ë²•:", "").trim(),
                    };
                    console.log(JSON.stringify(productData,));

                    // AJAX ìš”ì²­ìœ¼ë¡œ í´ë¦­ ë¡œê·¸ ì €ì¥
                    fetch('/log_click/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')  // CSRF í† í° ì¶”ê°€
                        },
                        body: JSON.stringify(productData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            console.log("Click logged successfully:", productData);
                        } else {
                            console.error("Error logging click:", data.message);
                        }
                    })
                    .catch(error => console.error("Error:", error));
                });
            });

            // CSRF í† í° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });


    </script>
</head>
<body>
    {% csrf_token %}
    <header>
        <div class="navbar">
            <div class="logo">
                <a href="{% url 'loginmain' %}">
                    <img src="{% static 'img/header_logo.png' %}" alt="ë¡œê³ ">
                </a>
            </div>
            <div class="nav-links">
                <a href="{% url 'originreport' %}">ë‚´ ê¸ˆìœµ ë°”ë¡œë³´ê¸°</a>
                <div class="dropdown">
                    <a href="#">ë‚´ ì˜ˆ/ì ê¸ˆ ì°¾ê¸°</a>
                    <div class="dropdown-content">
                        <a href="{% url 'top5' %}">ì‹ ê·œìƒí’ˆì¶”ì²œ</a>
                        <a href="{% url 'better' %}">ê¸°ì¡´ìƒí’ˆë¹„êµ</a>
                        <a href="{% url 'search' %}">ìƒí’ˆê²€ìƒ‰</a>
                    </div>
                </div>
                <a href="{% url 'spending_mbti' %}">ìŠ¬ê¸°ë¡œìš´ ì†Œë¹„ìƒí™œ</a>
            </div>
            <div class="user-info">
                <span>{{ user_name }}ë‹˜</span>
                <a href="./mypage">ë§ˆì´í˜ì´ì§€</a>
                <form method="POST" action="{% url 'logout' %}">
                    {% csrf_token %}
                    <button name="logout" style="margin-top: -8px;" >ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </div>
        </div>
    </header>

    <div class="container">
        <form method="POST" action="{% url 'search' %}">
            {% csrf_token %}
            <h2>ê¶ê¸ˆí•œ ìƒí’ˆì„ ê²€ìƒ‰í•´ë´ëë•~ ğŸ¦†</h2>
            <div class="search-bar">
                <input type="text" id="search-input" name="question" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." />
                <button type="submit" id="search-button">ê²€ìƒ‰</button>
            </div>
        </form>

    <div class="keywords">
        <!-- ê²€ìƒ‰ í‚¤ì›Œë“œ í‘œì‹œ -->
        {% if keywords %}
            {% for keyword in keywords %}
                <div class="keyword-box">
                    <span>{{ keyword }}</span>
                    <button class="delete-keyword">x</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

        <div class="search-results">
            <h2>ê²€ìƒ‰ ê²°ê³¼ë‹· ë•~ ğŸ¦†</h2>
            <ul id="results-list">
                {% for result in results %}
                <li class="card">
                    <div class="card-content_n">
                        <!-- ì˜ˆì ê¸ˆ êµ¬ë¶„ì— ë”°ë¥¸ ì´ë¯¸ì§€ ë Œë”ë§ -->
                        {% if result.Type == "ì ê¸ˆ" %}
                            <img src="{% static 'img/ì ê¸ˆ.PNG' %}" alt="ì ê¸ˆ ë¡œê³ " class="product-image">
                        {% elif result.Type == "ì˜ˆê¸ˆ" %}
                            <img src="{% static 'img/ì˜ˆê¸ˆ.PNG' %}" alt="ì˜ˆê¸ˆ ë¡œê³ " class="product-image">
                        {% else %}
                            <img src="{% static 'img/ì²œëƒ¥ë§Œë•2.png' %}" alt="ê¸°ë³¸ ë¡œê³ " class="product-image">
                        {% endif %}
            
                        <!-- í…ìŠ¤íŠ¸ ë‚´ìš© -->
                        <h3 class="card-title">{{ result.Name }}</h3>
                        <p><strong>ì€í–‰:</strong> {{ result.Bank }}</p>
                        <p><strong>ê¸°ì¤€ ê¸ˆë¦¬:</strong> {{ result.BaseR }}</p>
                        <p><strong>ìµœëŒ€ ê¸ˆë¦¬:</strong> {{ result.MaxIR }}</p>
                        <p><strong>ê°€ì… ë°©ë²•:</strong> {{ result.Method }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div class="pagination">
                {% for page in page_numbers %}
                    {% if page == current_page %}
                        <span class="item active">{{ page }}</span>
                    {% else %}
                        <a href="?page={{ page }}&size={{ page_size }}" class="item">{{ page }}</a>
                    {% endif %}
                {% endfor %}
            </div>
            <!-- ì£¼ì„: í˜ì´ì§€ë„¤ì´ì…˜ ì¶”ê°€ -->
        </div>
    </div>

    <footer>
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0; font-size: 0.8rem;">ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¶ë¡œ 434 ìƒì•”ITíƒ€ì›Œ 6ì¸µ</p> 
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0; font-size: 0.8rem;">ê³ ê°ì§€ì› : 02-3151-7000 | ì´ë©”ì¼: woorifis.lab44@gmail.com </p >
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0; font-size: 0.8rem;">COPYRIGHTÂ©ìš°ë¦¬ì²œë§Œí•´ìš”</p >
    </footer>
</body>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const addKeywordButton = document.getElementById("add-keyword-button"); // id ìˆ˜ì •ë¨
    const searchButton = document.getElementById("search-button");
    const keywordsContainer = document.querySelector(".keywords");
    const resultsList = document.getElementById("results-list");

    let keywords = []; // í‚¤ì›Œë“œë¥¼ ì €ì¥í•˜ëŠ” ë°°ì—´

    // í‚¤ì›Œë“œ ì¶”ê°€í•˜ê¸° ë²„íŠ¼ í´ë¦­
    addKeywordButton.addEventListener("click", function () {
        const keyword = searchInput.value.trim();

        if (keyword && !keywords.includes(keyword)) {
            keywords.push(keyword);
            addKeywordToUI(keyword);
            searchInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
        }
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
    searchButton.addEventListener("click", function () {
        const keyword = searchInput.value.trim();
        if (keyword && !keywords.includes(keyword)) {
            keywords.push(keyword);
        }
        displayResults(keywords);
        searchInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
    });

    // í‚¤ì›Œë“œ UIì— ì¶”ê°€
    function addKeywordToUI(keyword) {
        const keywordBox = document.createElement("div");
        keywordBox.classList.add("keyword-box");

        const keywordText = document.createElement("span");
        keywordText.textContent = keyword;

        const deleteButton = document.createElement("button");
        deleteButton.textContent = "x";
        deleteButton.classList.add("delete-keyword");
        deleteButton.addEventListener("click", function () {
            // í‚¤ì›Œë“œ ì‚­ì œ
            keywords = keywords.filter(k => k !== keyword);
            keywordsContainer.removeChild(keywordBox);
        });

        keywordBox.appendChild(keywordText);
        keywordBox.appendChild(deleteButton);
        keywordsContainer.appendChild(keywordBox);
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displayResults(keywords) {
        resultsList.innerHTML = ""; // ê¸°ì¡´ ê²°ê³¼ ì´ˆê¸°í™”

        if (keywords.length > 0) {
            keywords.forEach(keyword => {
                const li = document.createElement("li");
                li.textContent = `ê²°ê³¼: ${keyword}`;
                resultsList.appendChild(li);
            });
        } else {
            const li = document.createElement("li");
            li.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
            resultsList.appendChild(li);
        }
    }
});

</script>
