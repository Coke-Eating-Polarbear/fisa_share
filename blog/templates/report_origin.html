{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸ˆìœµë¶„ì„ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" href="{% static 'css/report_origin.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@2.1.3/marked.min.js"></script>
    <style>
    </style>
</head>
<body>
    {% csrf_token %}
    <header>
    <div class="navbar">
        <div class="logo">
            <a href="{% url 'loginmain' %}">
                <img src="{% static 'img\header_logo.png' %}" style="vertical-align: middle; margin-left: 100px;" alt="ë¡œê³ ">
            </div>
            <div class="nav-links" style="flex-grow: 1; text-align: center; margin-right: 220px;">
                <a href="{% url 'originreport' %}" style=" font-weight: bold; color: #121212;">ê¸ˆìœµë¶„ì„ ë¦¬í¬íŠ¸</a> 
                <div class="dropdown">
                    <a href="#" style=" font-weight: bold; color: #121212;">ì˜ˆ/ì ê¸ˆ ì¶”ì²œ</a>
                    <div class="dropdown-content">
                        <a href="{% url 'top5' %}" style="font-size: 0.8rem;">ì‹ ê·œì ê¸ˆì¶”ì²œ</a>
                        <a href="{% url 'better' %}" style="font-size: 0.8rem;">ê¸°ì¡´ìƒí’ˆë¹„êµ</a>
                    </div>
                </div> 
                <a href="{% url 'spending_mbti' %}" style=" font-weight: bold; color: #121212;">ì†Œë¹„MBTI</a>
            </div>
           <!-- íšŒì› ì •ë³´ ë° ë§ˆì´í˜ì´ì§€ -->
        <div class="user-info">
            <span style="font-size: 1.1rem;">{{ user_name }}ë‹˜</span> 
            <a href="{% url 'mypage' %}" style="margin-left: 15px; 
            text-decoration: none; 
            font-size: 1.1rem; 
            font-weight: bold; 
            color: #121212;">ë§ˆì´í˜ì´ì§€</a> 
            <form method="POST" action="{% url 'logout' %}" style="display: inline;">
                {% csrf_token %}
                <button name="logout" style="margin-left: 10px; 
                margin-right: 100px; 
                padding: 5px 10px; 
                font-size: 0.9rem; 
                font-weight: bold; 
                background-color: #291e4ee5; 
                color: white; 
                border: none; 
                border-radius: 5px; 
                cursor: pointer;">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </form>
        </div>
    </div>
    </header>

    <div class="container" style="margin-top: 60px;">
        <div class="content" style="justify-content: center; justify-items: center;">
            <div class="box">
                <h2>{{ user_name }}ë‹˜ì˜ ê¸ˆìœµë¶„ì„ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤</h2>
            </div>
            <div style="display: grid; grid-template-columns: 2fr 2fr 6fr; min-width: 75%; align-items: center; justify-content: center; justify-items: center; margin-left: 30px;">
                <div class="box" id="analysis-score" style="color: #5950d6; font-size: 60px; font-weight: bolder; margin-left: 0px; min-width: 75%; min-height: 72%; align-content: center;"></div>
                <div class="score-summary" style="min-width: 90%; min-height: 100%; align-content: center; margin-left: 10px; margin-right: 0%;"><span class="score-summary"></span></div>
                <div class="box" id="summary" style="font-weight: bolder; text-align: center; min-width: 85%;min-height: 72%; align-content: center; white-space: pre-line; margin-right: 0%; margin-left: 0%;"></div>
            </div>
            <div class="main-container" style="width: 90%; max-width: 1200px;">
                <!-- ë§‰ëŒ€ ê·¸ë˜í”„ ë°•ìŠ¤ -->
                <div class="bar-chart-container chart-box">
                    <div class="chart-box small">
                        <h3>ì´ìì‚°</h3>
                        <canvas id="chartTotal"></canvas>
                    </div>
                    <div class="chart-box small">
                        <h3>í˜„ê¸ˆìì‚°</h3>
                        <canvas id="chartCash"></canvas>
                    </div>
                    <div class="chart-box small">
                        <h3>ìˆ˜ì…</h3>
                        <canvas id="chartIncome"></canvas>
                    </div>
                    <div class="chart-box small">
                        <h3>ì§€ì¶œ</h3>
                        <canvas id="chartSpend"></canvas>
                    </div>
                </div>
            
                <!-- íŒŒì´ ì°¨íŠ¸ ë°•ìŠ¤ -->
                <div class="pie-chart-container chart-box">
                    <div class="chart-box small">
                        <h3>ìì‚° êµ¬ì„± ë¹„ìœ¨</h3>
                        <canvas id="pieChart1"class="chart"></canvas>
                    </div>
                    <div class="chart-box small">
                        <h3>ì§€ì¶œ êµ¬ì„± ë¹„ìœ¨</h3>
                        <canvas id="pieChart2" class="chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="box report-summary">
                <h3>ë§Œë•ì´ê°€ ë¶„ì„í•œ ê¸ˆìœµ ë¦¬í¬íŠ¸</h3>
            
               {% if report %}
                    <p  id="report-container">{{ report }}</p>
                {% else %}
                    <p>ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    <form method="POST">
                        {% csrf_token %}
                        <button type="submit">ë¦¬í¬íŠ¸ ìƒì„±</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>


    <script>
        // DOMContentLoaded ì´ë²¤íŠ¸ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        document.addEventListener("DOMContentLoaded", function () {
            // Djangoì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScriptë¡œ ë¡œë“œ
            const markdownReport = `{{ report|safe }}`;

            // ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            document.getElementById('report-container').innerHTML = marked(markdownReport);
        });

        // Djangoì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScriptë¡œ ë¡œë“œ
        const barData = JSON.parse('{{ bar_data|safe }}');
        const averageData = JSON.parse('{{ average_data|safe }}');
        // ë°ì´í„° í‚¤ì™€ ê°’
        const categories = Object.keys(barData); // ['ì´ìì‚°', 'í˜„ê¸ˆìì‚°', 'ìˆ˜ì…', 'ì§€ì¶œ']
        const userValues = Object.values(barData);
        const averageValues = Object.values(averageData);

        // í”ŒëŸ¬ê·¸ì¸: ê° ì°¨íŠ¸ì— ìˆ˜í‰ì„ (í‰ê·  ë°ì´í„°) ì¶”ê°€
        const drawAverageLinePlugin = {
            id: 'drawAverageLine',
            afterDatasetsDraw(chart) {
                const { ctx, scales } = chart;
                const yAxis = scales.y;
                const xAxis = scales.x;

                // í‰ê· ê°’ ê°€ì ¸ì˜¤ê¸°
                const averageValue = chart.config.options.plugins.averageLine.value;

                // ìˆ˜í‰ì„  ê·¸ë¦¬ê¸°
                const yPos = yAxis.getPixelForValue(averageValue); // Yì¶• ê°’ ìœ„ì¹˜ ê³„ì‚°
                const xStart = xAxis.left; // ì°¨íŠ¸ ì™¼ìª½ ë
                const xEnd = xAxis.right; // ì°¨íŠ¸ ì˜¤ë¥¸ìª½ ë

                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = 'red'; // ìˆ˜í‰ì„  ìƒ‰ìƒ
                ctx.lineWidth = 2;
                ctx.moveTo(xStart, yPos);
                ctx.lineTo(xEnd, yPos);
                ctx.stroke();
                ctx.restore();
            }
        };

        // ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
        function createBarChart(chartId, label, userValue, averageValue) {
            const ctx = document.getElementById(chartId).getContext('2d');

            // // Yì¶• ë²”ìœ„ ê³„ì‚°
            // const range = Math.abs(userValue - averageValue);
            // const buffer = range * 0.5;
            // const minValue = Math.min(userValue, averageValue) - buffer;
            // const maxValue = Math.max(userValue, averageValue) + buffer;
            // const stepSize = 50000;

            // í‰ê· ì„  í”ŒëŸ¬ê·¸ì¸
            const averageLinePlugin = {
                id: 'averageLine',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    const yScale = chart.scales.y;
                    const xScale = chart.scales.x;

                    const averageY = yScale.getPixelForValue(averageValue);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(xScale.left, averageY);
                    ctx.lineTo(xScale.right, averageY);
                    ctx.strokeStyle = '#FF0000'; // í‰ê· ì„  ìƒ‰ìƒ (ë¹¨ê°•)
                    ctx.lineWidth = 2;
                    ctx.setLineDash([15, 10]);
                    ctx.stroke();
                    ctx.restore();

                    // í‰ê· ì„  ë ˆì´ë¸” ì¶”ê°€
                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'lightgray';
                    ctx.fillText(`í‰ê· : ${averageValue.toLocaleString()}ì›`, xScale.right - 100, averageY - 5);
                    }
                };

            // ì°¨íŠ¸ë³„ ì„¤ì •ê°’ ì •ì˜
            const chartSettings = {
                'ì´ìì‚°': {
                    min: 100000000,
                    max: 250000000,
                    stepSize: 30000000,
                    format: value => (value / 10000).toLocaleString() + 'ë§Œì›'
                },
                'í˜„ê¸ˆìì‚°': {
                    min: 30000000,
                    max: 40000000,
                    stepSize: 2000000,
                    format: value => (value / 10000).toLocaleString() + 'ë§Œì›'
                },
                'ìˆ˜ì…': {
                    min: 0,
                    max: 3500000,
                    stepSize: 100000,
                    format: value => (value / 10000).toLocaleString() + 'ë§Œì›'
                },
                'ì§€ì¶œ': {
                    min: 0,
                    max: 2500000,
                    stepSize: 50000,
                    format: value => (value / 10000).toLocaleString() + 'ë§Œì›'
                }
            };

            const settings = chartSettings[label];


                // ì°¨íŠ¸ ìƒì„±
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [label], // ë‹¨ì¼ ë ˆì´ë¸”
                        datasets: [{
                                label: 'ì‚¬ìš©ì ë°ì´í„°',
                                data: [userValue],
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                    },
                    options: {
                        scales: {
                            y: {
                                min: settings.min,
                                max: settings.max,
                                ticks: {
                                    stepSize: settings.stepSize,
                                    callback: settings.format
                                }

                            }
                    },
                    plugins: {
                        legend: {
                                display: false // ë²”ë¡€ ìˆ¨ê¹€
                            },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const diff = context.raw - averageValue;
                                    return `ì‚¬ìš©ì ë°ì´í„°: ${context.raw.toLocaleString()}ì›\n(í‰ê· ë³´ë‹¤ ${diff > 0 ? '+' : ''}${diff.toLocaleString()}ì›)`;
                                }
                            }
                        }
                      }
                    }, 
                    plugins: [averageLinePlugin]
                });
            }


        // 4ê°œì˜ ê·¸ë˜í”„ ìƒì„±
        createBarChart('chartTotal', 'ì´ìì‚°', userValues[0], averageValues[0]);
        createBarChart('chartCash', 'í˜„ê¸ˆìì‚°', userValues[1], averageValues[1]);
        createBarChart('chartIncome', 'ìˆ˜ì…', userValues[2], averageValues[2]);
        createBarChart('chartSpend', 'ì§€ì¶œ', userValues[3], averageValues[3]);




        // íŒŒì´ ì°¨íŠ¸ ë°ì´í„°

        const sortedCategoriesJson = '{{ sorted_categories_json|safe }}'; // Django í…œí”Œë¦¿ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const sortedCategories = JSON.parse(sortedCategoriesJson); // JSON ë¬¸ìì—´ì„ ê°ì²´ë¡œ ë³€í™˜
        
        const assetDataJson = '{{ mydata_assets_json|escapejs|safe }}'; // ì•ˆì „í•˜ê²Œ JavaScriptìš© JSONìœ¼ë¡œ ë³€í™˜
        console.log("Raw assetDataJson:", assetDataJson);
        const assetData = JSON.parse(assetDataJson);
        
        console.log("Parsed assetData:", assetData);

            

        // Chart.jsì—ì„œ ì‚¬ìš©í•  ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const pieData2 = {
            labels: Object.keys(sortedCategories), // í•­ëª© ì´ë¦„ (ì˜ˆ: ì‹ë¹„, êµí†µë¹„, í†µì‹ ë¹„ ë“±)
            datasets: [
                {
                    data: Object.values(sortedCategories), // ê° í•­ëª©ì˜ ê°’
                    backgroundColor: [ // ì°¨íŠ¸ì˜ ìƒ‰ìƒ ë°°ì—´
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                        '#9966FF', '#FF9F40', '#FFCD56', '#FF6384'
                    ],
                }
            ]
        };

        const pieData1 = {
            labels: Object.keys(assetData), // í•­ëª© ì´ë¦„ (ì˜ˆ: ì‹ë¹„, êµí†µë¹„, í†µì‹ ë¹„ ë“±)
            datasets: [
                {
                    data: Object.values(assetData), // ê° í•­ëª©ì˜ ê°’
                    backgroundColor: [ // ì°¨íŠ¸ì˜ ìƒ‰ìƒ ë°°ì—´
                        '#FF6384', '#36A2EB', '#FFCE56'
                    ],
                }
            ]
        };

        // íŒŒì´ ì°¨íŠ¸ ìƒì„± í•¨ìˆ˜
        function createPieChart(chartId, data) {
            const ctx = document.getElementById(chartId).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right', // ë²”ë¡€ë¥¼ ì˜¤ë¥¸ìª½ì— ë°°ì¹˜
                            labels: {
                                filter: function(legendItem, data) {
                                    return legendItem.index < 5; // Top 5 í•­ëª©ë§Œ í‘œì‹œ
                            }
                          }
                        }
                    }
                }
            });
        }

        // ê°ê°ì˜ `<canvas>` IDë¡œ ì°¨íŠ¸ë¥¼ ìƒì„±
        createPieChart('pieChart1', pieData1); // ì²« ë²ˆì§¸ ì°¨íŠ¸ (MyDataAsset ê¸°ë°˜)
        createPieChart('pieChart2', pieData2); // ë‘ ë²ˆì§¸ ì°¨íŠ¸ (Sorted Categories ê¸°ë°˜)

        document.addEventListener("DOMContentLoaded", function () {

            const totalIncome = userValues[2]; // ì´ìˆ˜ì…
            const totalSpending = userValues[3]; // ì´ì§€ì¶œ
            const averageIncome = averageValues[2]; // í‰ê· ìˆ˜ì…

            // A ê³„ì‚° (ì§€ì¶œ/ìˆ˜ì… ë¹„ìœ¨)
            const spendingRatio = (totalSpending / totalIncome) * 100;
            let aStatus;
            if (spendingRatio <= 50) {
                aStatus = "ì¢‹ìŒ";
            } else if (spendingRatio <= 70) {
                aStatus = "ë³´í†µ";
            } else {
                aStatus = "ë‚˜ì¨";
            }

            // B ê³„ì‚° (í‰ê·  ìˆ˜ì…ê³¼ ë¹„êµ)
            const bStatus = totalIncome > averageIncome ? "ë†’ìŒ" : "ë‚®ìŒ";

            // ì ìˆ˜ì™€ ê¸ˆìœµ ë‚ ì”¨ ê²°ì •
            let score, condition, summary, emoji;
            if (aStatus === "ì¢‹ìŒ" && bStatus === "ë†’ìŒ") {
                score = 100;
                condition = "Excellent";
                summary = "ëª¨ë“  ì¡°ê±´ì´ ì´ìƒì ì´ë©°, ì¬ì • ìƒíƒœê°€ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤.\n" + "ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œ ë¹„ìœ¨ì´ ì¢‹ê³  í‰ê·  ì´ìƒìœ¼ë¡œ ì•ˆì •ì ì´ë©°\n" +"ì¥ê¸°ì ì¸ ì¬ì • ê´€ë¦¬ê°€ ë§¤ìš° ì–‘í˜¸í•œ í¸ì…ë‹ˆë‹¤.";
                emoji = "ğŸ˜";
            } else if (aStatus === "ì¢‹ìŒ" && bStatus === "ë‚®ìŒ") {
                score = 90;
                condition = "VeryGood";
                summary = "ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œ ë¹„ìœ¨ì´ ì¢‹ì§€ë§Œ í‰ê· ì— ë¹„í•´ ì‚´ì§ ë‚®ì€ í¸ì…ë‹ˆë‹¤.\n" + "ì¬ì •ì ìœ¼ë¡œ ì•ˆì •ì ì´ì§€ë§Œ ì¡°ê¸ˆ ë” ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                emoji = "ğŸ¥°";
            } else if (aStatus === "ë³´í†µ" && bStatus === "ë†’ìŒ") {
                score = 80;
                condition = "Good";
                summary = "í‰ê· ë³´ë‹¤ ìˆ˜ì…ì´ ë†’ê³ , ì¬ì •ìƒíƒœê°€ ë¬´ë‚œí•˜ì§€ë§Œ ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œì´ ë†’ì€ í¸ì…ë‹ˆë‹¤.\n" +"ì§€ì¶œ ë¶€ë¶„ì„ ì•½ê°„ ê°œì„ í•œë‹¤ë©´ ë” ì¢‹ì€ ì¬ì •ìƒíƒœê°€ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ";
                emoji = "ğŸ˜€";
            } else if (aStatus === "ë³´í†µ" && bStatus === "ë‚®ìŒ") {
                score = 70;
                condition = "Soso";
                summary = "ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œì˜ ë¹„ì¤‘ì´ ë†’ì€í¸ì€ ì•„ë‹ˆì§€ë§Œ\n"+"í‰ê·  ìˆ˜ì…ì„ ê³ ë ¤í•œë‹¤ë©´ ì¡°ê¸ˆ ë” ê´€ë¦¬ì™€ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                emoji = "ğŸ˜Š";
            } else if (aStatus === "ë‚˜ì¨" && bStatus === "ë†’ìŒ") {
                score = 60;
                condition = "NotBad";
                summary = "í‰ê· ë³´ë‹¤ ì†Œë“ì´ ë†’ì€ í¸ì´ì§€ë§Œ ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œì´ ë§ìŠµë‹ˆë‹¤.\n" + "ì¥ê¸°ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ì¬ì • ìƒíƒœë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ì„  ì¶”ê°€ì ì¸ ê´€ë¦¬ì™€ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                emoji = "ğŸ¥²";
            } else {
                score = 50;
                condition = "Bad";
                summary = "ìˆ˜ì… ëŒ€ë¹„ ì§€ì¶œì´ ë†’ì•„ ì¬ì • ìƒíƒœê°€ ì¢‹ì§€ì•Šì€ ìœ„í—˜í•œ ìƒíƒœì…ë‹ˆë‹¤.\n" + "ì¦‰ê°ì ì¸ ì¬ì • ê´€ë¦¬ì™€ ê°œì„  ì¡°ì¹˜ê°€ í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤.";
                emoji = "ğŸ˜¢";
            }

            // ë°ì´í„° í™”ë©´ì— ì¶œë ¥
            document.getElementById('analysis-score').textContent = `${score}ì `;
            document.getElementById('summary').textContent = summary;
            document.querySelector('.score-summary').textContent = emoji;
        });


    </script>

    <footer>
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0;">ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì›”ë“œì»µë¶ë¡œ 434 ìƒì•”ITíƒ€ì›Œ 6ì¸µ</p> 
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0;">ê³ ê°ì§€ì› : 02-3151-7000 | ì´ë©”ì¼: woorifis.lab44@gmail.com </p >
        <p style="margin: 5px; line-height: 1.2; text-decoration: none; color: #afafb0;">COPYRIGHTÂ©ìš°ë¦¬íŒ€ì´ë¦„~</p >
    </footer >
</body>
</html>